name: Build and Release CMake Project

on:
  push:
    # branches:
    #   - master
    tags:
      - '*' # Push events to every tag not containing /

jobs:
  build-and-release:
    name: Build and Upload Release Artifact
    runs-on: ubuntu-latest

    permissions:
      contents: write # Required to upload to a GitHub release

    steps:
      # Check out the repository
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch all history to include tags

      # Install dependencies
      - name: Install OpenGL and related libraries
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake g++ make libglew-dev freeglut3-dev libgl1-mesa-dev libglu1-mesa-dev

      # Configure and build using CMake
      - name: Build project
        run: |
          mkdir build
          cd build
          cmake ..
          cmake --build . --config Release

      # Archive the build artifacts
      - name: Archive build artifacts
        run: |
          mkdir artifacts
          cp build/latrop artifacts/  # Copy the latrop binary
          cp -r build/data artifacts/  # Copy the data folder
          cp -r build/maps artifacts/  # Copy the maps folder
          tar -czf build-artifacts.tar.gz -C artifacts .


      # Fetch the history of commits and append it to the release
      - name: Fetch commit messages
        id: get_commits
        run: |
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^)
          echo "Previous tag: $PREVIOUS_TAG"
          echo "PREVIOUS_TAG=$PREVIOUS_TAG" >> $GITHUB_ENV

          # Fetch commit messages only, excluding commit IDs
          COMMITS=$(git log $PREVIOUS_TAG..HEAD --pretty=format:"%s" --reverse)
          echo "Commit messages between $PREVIOUS_TAG and current tag:"
          echo "$COMMITS"

          # Initialize formatted commits variable
          FORMATTED_COMMITS=""
          COUNTER=1

          # Process each commit
          while read -r commit; do
            FORMATTED_COMMITS+=$'\n'"- commit ${COUNTER}:"
            IFS=';' read -ra SUBCOMMITS <<< "$commit"
            for subcommit in "${SUBCOMMITS[@]}"; do
              # Remove version pattern (e.g., "(version X.Y.Z)")
              CLEANED_SUBCOMMIT=$(echo "$subcommit" | sed -E 's/\s*\(version [0-9]+\.[0-9]+\.[0-9]+\)//g')
              FORMATTED_COMMITS+=$'\n'"  - ${CLEANED_SUBCOMMIT}"
            done
            ((COUNTER++))
          done <<< "$COMMITS"

          echo "FORMATTED_COMMITS<<EOF" >> $GITHUB_ENV
          echo -e "$FORMATTED_COMMITS" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      # Upload the artifact as part of the release
      - name: Create GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create
          '${{ github.ref_name }}'
          --repo '${{ github.repository }}'
          --notes "Latest package release ${{ github.ref_name }}
          
          ## Changes:
          
          ${{ env.FORMATTED_COMMITS }}"

      - name: Upload artifact to GitHub Release
        env:
          GITHUB_TOKEN: ${{ github.token }}
        # Upload to GitHub Release using the `gh` CLI.
        # `build-artifacts.tar.gz` contains the built game
        run: >-
          gh release upload
          '${{ github.ref_name }}'
          build-artifacts.tar.gz
          --repo '${{ github.repository }}'
